<dom-module id="project-edit-card">
    <link rel="import" href="../bower_components/paper-card/paper-card.html">
    <link rel="import" href="../bower_components/paper-time-input/paper-time-input.html">
    <link rel="import" href="../bower_components/paper-button/paper-button.html">
    <link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
    <link rel="import" href="../bower_components/paper-time-picker/paper-time-picker.html">
    <link rel="import" href="../bower_components/paper-styles/paper-styles.html">
    <link rel="import" href="../bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="../bower_components/iron-icon/iron-icon.html">
    <link rel="import" href="../bower_components/iron-icons/image-icons.html">
    <link rel="import" href="../bower_components/paper-fab/paper-fab.html">
    <link rel="import" href="project-autocomplete.html">
    <link rel="import" href="activity-entry.html">
    <link rel="import" href="../bower_components/neon-animation/neon-animation.html">
    <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>

    <style>
        .card-content {
            width: 275px;
            padding: 0 16px 16px;
            display: grid;

            grid-template-areas: "pro pro" "bdy bdy" "cc tot";
            grid-template-rows: 4em 6fr 2fr;
            grid-template-columns: 3fr 1fr;
            grid-column-gap: 3%;

            border-left: 1px solid rgba(7,7,7,.25);
        }

        /*.card-content[hidden]{*/
            /*display: none;*/
        /*}*/

        #projectAutocomplete {
            grid-area: pro;
        }

        #activities {
            grid-area: bdy;
        }

        #ccAutocomplete {
            grid-area: cc;
        }

        paper-fab.red {
            --paper-fab-background: #e53935;
            --paper-fab-keyboard-focus-background: #f44336;
        }
    </style>
    <script src="../js/moment.js"></script>
    <template>

        <div class="card-content" style="height: 100%;">

            <project-autocomplete id="projectAutocomplete" text-value="{{projectName}}" label="Project" highlight-first
                                  show-results-on-focus></project-autocomplete>
            <div id="activities" style="max-height: 100%; overflow: auto;" class="new-field">
            </div>
            <paper-autocomplete id="ccAutocomplete" label="Corp Code" text="{{corpCode}}" highlight-first
                                show-results-on-focus></paper-autocomplete>
            <paper-fab id="removeProject" style="transform: translate(50%, 50%);" class="red" mini
                       icon="icons:remove"></paper-fab>
        </div>
        <script>
        </script>
    </template>
    <script src="../js/moment.js"></script>

    <script>

        Polymer({
            is: "project-edit-card",

            //For the current day, we only get one temp, which is passed into the hi AND lo. When both are the same, we format it differently.
            properties: {
                removeCardTrigger: {
                    type: Boolean,
                    notify: true,
                    readOnly: false,
                    value: false
                },
                // hidden: {
                //     type: Boolean,
                //     notify: true,
                //     readOnly: false,
                //     value: true
                // },

                projectName: {
                    type: String,
                    notify: true,
                    readOnly: false
                },
                totalProjectMins: {
                    type: String,
                    notify: true,
                    readOnly: false,
                    value: "00"
                },
                totalProjectHours: {
                    type: String,
                    notify: true,
                    readOnly: false,
                    value: "00"
                },
                //activity set holds [ { activityName: "", activityTime: "" }, ... ]
                activityData: String,
                corpCode: {
                    type: String,
                    notify: true,
                    readOnly: false
                }
            },

            // this. is the projectAutocomplete
            _updateProjectName: function () {
                //updating Overview Name
                this.parentElement.parentElement.projectName = this.textValue;

                var cardContent = this.parentElement;
                var activities = cardContent.querySelector("#activities");
                if(this.textValue === ""){
                    activities.childNodes.forEach(function(entry){
                        entry.disabled = true;
                    });
                } else {
                    activities.childNodes.forEach(function(entry){
                        entry.disabled = false;
                    });
                }
            },

            // this. is the ccAutocomplete.
            _updateCorpCode: function () {
                console.log("eyyyy");
                var cc = ['Kirby', 'ABC', 'NBSSC', 'NBSIN', 'Other'];

                // Check if the typed corpCode (cc) is in the array and valid.
                var cardContent = this.parentElement;
                var projectAutocomplete = cardContent.querySelector("#projectAutocomplete");
                var activities = cardContent.querySelector("#activities");
                if(this.text === "" || this.text === null || this.text === undefined){
                    projectAutocomplete.disabled = true;
                    activities.childNodes.forEach(function(entry){
                        entry.disabled = true;
                    });
                }
                // //Literal Easter egg.
                // else if (this.text.match(/egg/i)) {
                //     var eggURL = "https://www.walmart.com/ip/Great-Value-Large-Grade-A-Eggs-12-ct/145051970";
                //     var win = window.open(eggURL, '_blank');
                //     this.text = "";
                //     win.focus();
                // }
                else {
                    projectAutocomplete.disabled = false;
                    activities.childNodes.forEach(function(entry){
                        entry.disabled = false;
                    });
                }
            },

            ready: function () {
                /*Event Initialization*/
                var btn = this.$.removeProject.addEventListener("click", this._deleteCard);
                this.$.projectAutocomplete.addEventListener("change", this._updateProjectName);
                this.$.projectAutocomplete.addEventListener("input", this._updateProjectName);
                this.$.projectAutocomplete.addEventListener("focusout", this._updateProjectName);
                this.$.ccAutocomplete.addEventListener("change", this._updateCorpCode);
                this.$.ccAutocomplete.addEventListener("input", this._updateCorpCode);
                this.$.ccAutocomplete.addEventListener("focusout", this._updateCorpCode);

                //initializing totalProjectTime update function for each input
                //TODO put this in the custom element
                // var node = this.$.activities.querySelector("paper-time-input");
                // var updateTotalTime = node.parentElement.parentElement.parentElement.parentElement._updateTotalTime;
                // node.addEventListener("min-changed", updateTotalTime);
                // node.addEventListener("hour-changed", updateTotalTime);

                /*auto complete population*/
                var projects = ['eQuote', 'Steel Store', 'Design Tools', 'Bomsnet/SICM', 'Tekla', 'Back Office Release',
                    'Detailing Release', 'Other Applications', 'Administrative'
                ];
                var cc = ['Kirby', 'ABC', 'NBSSC', 'NBSIN', 'Other'];

                //TODO Fix this with the custom element
                // var activityAutocomplete = this.$.activityAutocomplete;
                // activityAutocomplete.source = activities;
                var ccAutocomplete = this.$.ccAutocomplete;
                ccAutocomplete.source = cc;

            },

            listeners: {
                'state-changed': '_appendActivity',
                'mins-spent-changed': '_updateTotalTime',
                'hours-spent-changed': '_updateTotalTime'
            },

            _filterEntries(activitiesContainer, activityEntries) {
                activityEntries.length = 0;
                activitiesContainer.childNodes.forEach(function (element) {
                    if (element.tagName === "ACTIVITY-ENTRY") {
                        activityEntries.push(element);
                    }
                });
            },

            _appendActivity() {
                var activitiesContainer = this.$.activities;

                // Find all of the activity-entry's in #activities
                var activityEntries = [];
                this._filterEntries(activitiesContainer, activityEntries);

                // Filter the activity-entry's to remove <text> elements.

                // Count how many entries are empty
                var emptyEntries = 0;
                var partialEntries = 0;
                var filledEntries = 0;
                activityEntries.forEach(function (entry) {
                    if (entry.state === "empty") {
                        emptyEntries++;
                    } else if (entry.state === "partial") {
                        partialEntries++;
                    } else if (entry.state === "filled") {
                        filledEntries++;
                    }
                });

                //If there are one or more filled entries, and there aren't any empty entries, append a new one.
                if (filledEntries >= 1) {
                    if (!emptyEntries >= 1) {
                        var newEntry = document.createElement('activity-entry');
                        // Append the new activity-entry
                        activitiesContainer.appendChild(newEntry);
                    }
                } else if (filledEntries === 0 && partialEntries === 0 && emptyEntries === 0) {
                    var newEntry = document.createElement('activity-entry');
                    // Append the new activity-entry
                    activitiesContainer.appendChild(newEntry);
                }

                this._filterEntries(activitiesContainer, activityEntries);

                emptyEntries = 0;
                partialEntries = 0;
                filledEntries = 0;
                activityEntries.forEach(function (entry) {
                    if (entry.state === "empty") {
                        emptyEntries++;
                    } else if (entry.state === "partial") {
                        partialEntries++;
                    } else if (entry.state === "filled") {
                        filledEntries++;
                    }
                });

                //If there are one or more partial entries, remove any empty ones.
                if (partialEntries >= 1) {
                    activityEntries.forEach(function (entry) {
                        if (entry.state === "empty") {
                            activitiesContainer.removeChild(entry);
                        }
                    });
                }
            },

            attached: function () {
                var activitiesContainer = this.$.activities;
                var editCard = this;
                var activityEntry;
                var activityData;

                if (this.activityData !== undefined) {
                    activityData = JSON.parse(this.activityData);

                    activityData.forEach(function(activity){
                        activityEntry = document.createElement('activity-entry');
                        activityEntry.setAttribute("activity-name", activity.activityName);

                        var hoursSpent = 0;
                        var minutesSpent = activity.activityTime * 60;

                        while ((minutesSpent - 60) >= 0){
                            minutesSpent = minutesSpent - 60;
                            hoursSpent = hoursSpent + 1;
                        }

                        activityEntry.setAttribute("hours-spent", Math.floor(hoursSpent).toString());
                        activityEntry.setAttribute("mins-spent", Math.floor(minutesSpent).toString());
                        if (activityEntry.getAttribute("mins-spent") !== null) {
                            if (activityEntry.getAttribute("mins-spent").length < 2) {
                                activityEntry.setAttribute("mins-spent", "0" + activityEntry.getAttribute("mins-spent"));
                            }
                        }

                        activitiesContainer.appendChild(activityEntry);
                    });
                }
                this.fire("state-changed");
                this.fire("mins-spent-changed");
                this.fire("hours-spent-changed");
                this._updateProjectName();
                this._updateCorpCode();
            },
            //this. === the delete button
            _deleteCard: function () {
                var projectEditCard = this.parentElement.parentElement;
                var cardContent = this.parentElement.parentElement.parentElement;
                projectEditCard.removeCardTrigger = true;
                this.fire("edit-card-deleted");
                this.fire("total-project-hours-changed");
                // this.fire("edit-card-deleted");
                cardContent.removeChild(projectEditCard);
            },
            //find all minutes and hours and update totalProjectMins && totalProjectHours
            _updateTotalTime: function () {
                var activitiesContainer = this.$.activities;

                // Find all of the activity-entry's in #activities
                var activityEntries = [];
                this._filterEntries(activitiesContainer, activityEntries);

                var total = 0;

                activityEntries.forEach(function (entry) {
                    if (entry.state === "filled") {
                        var minutes = (parseInt(entry.hoursSpent) * 60) + (parseInt(entry.minsSpent));
                        total += minutes;
                    }
                });
                var totalDur = moment.duration(total, 'minutes');
                this.totalProjectHours = Math.floor(totalDur.asHours());
                this.totalProjectMins = Math.floor(totalDur.asMinutes()) % 60;
            }
        });
    </script>
</dom-module>